/**
 * @preserve
 * Flair.js Fabric
 * Foundation for True Object Oriented JavaScript Apps
 * 
 * Assembly: flair.server
 *     File: ./flair.server.js
 *  Version: 0.60.32
 *  Sat, 28 Sep 2019 02:07:52 GMT
 * 
 * (c) 2017-2019 Vikas Burman
 * MIT
 */
!function(e,t){"use strict";"function"==typeof!0&&(!0).amd?(!0)(()=>t):"object"==typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),module.exports=exports=t):e["flair.server"]=t}(this,async function(e,t){"use strict";const{Class:s,Struct:r,Enum:i,Interface:a,Mixin:n,Aspects:o,AppDomain:l,$$:c,InjectedArg:u,bring:p,Container:h,include:d,Port:f,on:g,post:m,telemetry:y,Reflector:v,Serializer:w,Tasks:b,as:S,is:x,isDefined:q,isComplies:R,isDerivedFrom:P,isAbstract:k,isSealed:O,isStatic:C,isSingleton:H,isDeprecated:$,isImplements:A,isInstanceOf:j,isMixed:I,getAssembly:D,getAttr:M,getContext:T,getResource:F,getRoute:N,getType:B,ns:E,getTypeOf:U,getTypeName:W,typeOf:J,dispose:L,using:V,Args:z,Exception:G,noop:K,nip:_,nim:Q,nie:X,event:Y}=e,{TaskInfo:Z}=e.Tasks,{env:ee}=e.options,{guid:te,stuff:se,replaceAll:re,splitAndTrim:ie,findIndexByProp:ae,findItemByProp:ne,which:oe,isArrowFunc:le,isASyncFunc:ce,sieve:ue,deepMerge:pe,getLoadedScript:he,b64EncodeUnicode:de,b64DecodeUnicode:fe,lens:ge,globalSetting:me}=e.utils,ye=ee.isServer||ee.isWorker?null:(!0).document,ve=l.context.current().name,we=t,be=we.substr(0,we.lastIndexOf("/")+1);l.loadPathOf("flair.server",be);let Se=JSON.parse('{"envVars":{"vars":[],"options":{"overwrite":true}},"express":{"server-http":{"enable":false,"port":80,"timeout":-1},"server-https":{"enable":false,"port":443,"timeout":-1,"privateKey":"","publicCert":""}},"routing":{"mounts":{"main":"/"},"all":{"before":{"settings":[],"middlewares":[]},"after":{"settings":[],"middlewares":[]}}}}'),xe=f("settingsReader");if("function"==typeof xe){let e=xe("flair.server");e&&(Se=pe([Se,e],!1))}Se=Object.freeze(Se);let qe=JSON.parse("{}");return qe=Object.freeze(qe),l.context.current().currentAssemblyBeingLoaded("./flair.server{.min}.js"),await(async()=>{const{Middleware:e}=await E("flair.app");c("ns","flair.app"),s("ServerMiddleware",e,function(){c("override"),this.run=(async(e,t,s,...r)=>{await this.onRun(e,t,...r),s()}),c("virtual"),c("async"),this.onRun=Q})})(),await(async()=>{const{Payload:e}=await E("flair.app"),t=await d("path");c("ns","flair.api"),s("AttachmentPayload",e,function(){c("override"),this.construct=((e,s,r,i,a,n,o,l)=>{if(!this.file)throw G.InvalidArgument("file");e(s,r,i,l),this.file=s||"",this.displayName=a||t.basename(this.file),this.options=n||null,this.cb=o||null,this.resHeaders.push({name:"Content-disposition",value:`attachment;filename=${this.displayName||"unknown.unknown"}`})}),c("readonly"),this.file="",c("readonly"),this.displayName="",c("readonly"),this.options=null,c("readonly"),this.cb=null})})(),await(async()=>{const{Payload:e}=await E("flair.app");c("ns","flair.api"),s("JSONPayload",e,function(){c("override"),this.construct=((e,t,s,r,i)=>{if(!t)throw G.InvalidArgument("data");e(t,s,"application/json",i),this.isJsonP=r||!1}),c("readonly"),this.isJsonP=!1})})(),await(async()=>{const{Payload:e}=await E("flair.app");c("ns","flair.api"),s("BinaryPayload",e,function(){c("override"),this.construct=((e,t,s,r,i,a,n)=>{if(!t)throw G.InvalidArgument("data");this.buffer=Buffer.from(t,this.encoding),e(this.buffer,s,r,n),this.cb=a||null,this.resHeaders.push({name:"Content-disposition",value:`attachment;filename=${i||"unknown.unknown"}`}),this.resHeaders.push({name:"Content-Length",value:this.buffer.length})}),c("readonly"),this.buffer=null,c("readonly"),this.encoding="binary",c("readonly"),this.cb=null})})(),await(async()=>{const{HandlerResult:e}=await E("flair.app");c("ns","flair.api"),s("RestHandlerResult",e,function(){c("override"),this.construct=((e,t,s,r)=>{e(t,s,r)})})})(),await(async()=>{const{HandlerContext:e}=await E("flair.app");c("ns","flair.api"),s("RestHandlerContext",e,function(){c("override"),this.construct=((e,t,s)=>{e(),this.req=t,this.res=s}),c("readonly"),this.req=null,c("readonly"),this.res=null,this.redirect=((e,t,s,r)=>{throw this.setData("redirect-route",e),this.setData("redirect-status",t||302),this.setData("redirect-params",s||null),this.setData("redirect-query",r||null),G.Redirect(e)}),this.isHeadersSent={get:()=>this.res.headersSent},this.getResHeader=(e=>this.res.get(e)),this.setHeader=((e,t,s)=>{s?this.res.append(e,t):this.res.set(e,t)}),this.setCookie=((e,t,s)=>{this.res.cookie(e,t,s)}),this.clearCookie=((e,t)=>{this.res.clearCookie(e,t)}),this.isAjaxReq={get:()=>this.req.xhr},this.isStale={get:()=>this.req.stale},this.isFresh={get:()=>this.req.fresh},this.isSecure={get:()=>this.req.secure},this.url={get:()=>this.req.url},this.originalUrl={get:()=>this.req.originalUrl},this.baseUrl={get:()=>this.req.baseUrl},this.route={get:()=>this.req.route},this.ip={get:()=>this.req.ip},this.ips={get:()=>this.req.ips},this.hostName={get:()=>this.req.hostname},this.subDomains={get:()=>this.req.subdomains},this.protocol={get:()=>this.req.protocol},this.path={get:()=>this.req.path},this.method={get:()=>this.req.method},this.body={get:()=>this.req.body},this.params={get:()=>this.req.params},this.query={get:()=>this.req.query},this.isContentType=(e=>"string"==typeof this.req.is(e)),this.getHeader=(e=>this.req.get(e)),this.getCookie=((e,t)=>{if(t){if(this.req.signedCookies)return this.req.signedCookies[e]||null}else if(this.req.cookies)return this.req.cookies[e]||null;return null}),this.acceptsContentType=((...e)=>this.req.accepts(e)),this.acceptsCharset=((...e)=>this.req.acceptsCharsets(e)),this.acceptsEncoding=((...e)=>this.req.acceptsEncodings(e)),this.acceptsLanguage=((...e)=>this.req.acceptsLanguages(e))})})(),await(async()=>{const{Handler:e}=await E("flair.app"),{RestHandlerResult:t}=await E("flair.api");c("ns","flair.api"),s("RestHandler",e,function(){c("override"),this.construct=((e,t)=>{e(t)}),c("override"),this.run=(async(e,s,r)=>{e(s,r);let i=null,a=null,n=null,o,l;switch(s){case"get":n=this.onGet;break;case"post":n=this.onPost;break;case"put":n=this.onPut;break;case"patch":n=this.onPatch;break;case"delete":n=this.onDelete;break;case"head":n=this.onHead;break;case"options":n=this.onOptions;break;case"trace":n=this.onTrace;break}if(n)try{i=await n(r)}catch(e){a=e}else a=G.NotImplemented(`Verb ${s} is not implemented.`);return!!!a&&x(i,t)||(i=new t(a,i)),i}),c("protected"),c("virtual"),c("async"),this.onGet=K,c("protected"),c("virtual"),c("async"),this.onPost=K,c("protected"),c("virtual"),c("async"),this.onPut=K,c("protected"),c("virtual"),c("async"),this.onPatch=K,c("protected"),c("virtual"),c("async"),this.onDelete=K,c("protected"),c("virtual"),c("async"),this.onHead=K,c("protected"),c("virtual"),c("async"),this.onOptions=K,c("protected"),c("virtual"),c("async"),this.onTrace=K})})(),await(async()=>{const{Host:e}=await E("flair.app");c("sealed"),c("ns","flair.app"),s("ServerHost",e,function(){let e={},t=null,s=null,r=Se.express["server-http"],i=Se.express["server-https"];c("override"),this.construct=(e=>{e("Server")}),this.app={get:()=>this.mounts["main"].app,set:K},this.mounts={get:()=>e,set:K},this.routeToUrl=((e,t,s)=>{if(!e)return null;let r=l.context.current().getRoute(e);if(!r)return re(e,".","_");let i=r.path;i.startsWith("/")||(i="/"+i);let a=!1;if(t){let e=-1,s="?",r=null;for(let a in t)t.hasOwnProperty(a)&&(e=i.indexOf(`:${a}`),r=encodeURIComponent(t[a].toString()),-1!==e?i=re(i,`:${a}`,r):s+=`${a}=${r}&`);"?"!==s&&(a=!0,s.endsWith("&")&&(s=s.substr(0,s.length-1)),i+=s)}if(s){let e=a?"&":"?",t=null;for(let r in s)s.hasOwnProperty(r)&&(e+=`${r}=${t=encodeURIComponent(s[r].toString())}&`);"?"===e&&"&"===e||(i+=e)}return i}),c("override"),this.boot=(async t=>{t();const s=await d("express | x"),r=(e,t)=>{let s=this.getMountSpecificSettings("settings",Se.routing,e,"name");if(s&&s.length>0)for(let e of s)t.set(e.name,e.value)};let i=s(),a=(Se.routing["main"]?Se.routing["main"]["params"]:"")||"";r("main",i);let n="",o=null,l="";for(let t of Object.keys(Se.routing.mounts))"main"===t?(n="/",o=i,l=a):(n=Se.routing.mounts[t],l=(Se.routing[t]?Se.routing[t]["params"]:"")||"",o=s()),e[t]=Object.freeze({name:t,root:n,params:l,app:o}),"main"!==t&&(r(t,o),i.use(n,o));e=Object.freeze(e)}),c("override"),this.start=(async e=>{if(e(),ee.x().isServerless)return;const a=await d("fs | x"),n=await d("http | x"),o=await d("https | x"),c=await d("http-shutdown | x");if(r.enable&&((t=c(t=n.createServer(this.app))).on("error",e=>{this.error(e)}),-1!==r.timeout&&(t.timeout=r.timeout)),i.enable){const e=a.readFileSync(l.resolvePath(i.privateKey),"utf8"),t=a.readFileSync(l.resolvePath(i.publicCert),"utf8"),r={key:e,cert:t};(s=c(s=o.createServer(r,this.app))).on("error",e=>{this.error(e)}),-1!==i.timeout&&(s.timeout=i.timeout)}}),c("override"),this.ready=(e=>new Promise((a,n)=>{if(e(),ee.x().isServerless)return void a();let o=r.port||80,c=process.env.PORT||i.port||443;t&&s?t.listen(o,()=>{s.listen(c,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${o}, https: ${c})`),a()})}):t?t.listen(o,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${o})`),a()}):s?s.listen(c,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (https: ${c})`),a()}):(console.log(`${l.app().info.name}, v${l.app().info.version}`),a())})),c("override"),this.stop=(async e=>{e(),ee.x().isServerless||(t&&(console.log("http server is shutting down..."),t.shutdown(()=>{t=null,console.log("http server is cleanly shutdown!")})),s&&(console.log("https server is shutting down..."),s.shutdown(()=>{s=null,console.log("https server is cleanly shutdown!")})))}),c("override"),this.dispose=(t=>{t(),e=null})})})(),await(async()=>{const{Bootware:e,ServerMiddleware:t}=await E("flair.app");c("sealed"),c("ns","flair.app.bw"),s("Middlewares",e,function(){c("override"),this.construct=(e=>{e(!0)}),c("override"),this.boot=(async(e,s)=>{e();const r=(e=[])=>{let t=[],s=null;for(let r of e){if("string"==typeof r&&r.startsWith("return "))s=new Function(r)();else if("object"==typeof r){for(let e in r)r.hasOwnProperty(e)&&"string"==typeof(s=r[e])&&s.startsWith("return ")&&(s=new Function(r)(),r[e]=s);s=r}else s=r;t.push(s)}return t};let i=this.getMountSpecificSettings("middlewares",Se.routing,s.name,"name");if(i&&i.length>0){let e=null,a=null,n=null,o=null;for(let l of i)try{let i=r(l.args);n=null,o=null,e=await d(l.name),x(e,"flairtype")&&S(e,t)?(o=new(n=e),a=function(e,...t){return function(s,r,i){e.run(s,r,i,...t)}}):a=l.func?e[l.func]:e,o?s.app.use(a(o,...i)):s.app.use(a(...i))}catch(e){throw G.OperationFailed(`Middleware ${l.name} load failed.`,e,this.boot)}}})})})(),await(async()=>{const{Bootware:e}=await E("flair.app");c("sealed"),c("ns","flair.app.bw"),s("NodeEnv",e,function(){c("override"),this.boot=(async e=>{if(e(),Se.envVars.vars.length>0){const e=await d("node-env-file | x");if(e)for(let t of Se.envVars.vars)e(l.resolvePath(t),Se.envVars.options)}})})})(),await(async()=>{const{Bootware:e,ServerMiddleware:t,Payload:r}=await E("flair.app"),{RestHandler:i,RestHandlerResult:a,RestHandlerContext:n,AttachmentPayload:o,BinaryPayload:u,JSONPayload:p}=await E("flair.api");c("sealed"),c("ns","flair.app.bw"),s("ServerRouter",e,function(){let e=null;c("override"),this.construct=(e=>{e(!0)}),c("override"),this.boot=(async(s,c)=>{s(),e||(e=l.context.current().allRoutes(!0)).sort((e,t)=>e.index<t.index?-1:e.index>t.index?1:0);const h=(e,t,s)=>{let i=t.req,a=t.res;if(302===e.status){let e=t.getData("redirect-route"),s=t.getData("redirect-status"),r=t.getData("redirect-params"),i=t.getData("redirect-query"),n=l.host().routeToUrl(e,r,i);a.redirect(s,n)}else{let s=!1;if(!e.isError&&x(e.data,r)){for(let t of e.data.resHeaders)a.set(t.name,t.value);x(e.data,o)?(s=!0,a.download(e.data.file,e.data.displayName,e.data.options,e.data.cb).end()):x(e.data,u)?(s=!0,a.end(e.data.buffer,e.data.encoding,e.data.cb)):x(e.data,p)&&(s=!0,a.status(e.status).jsonp(e.value(!0)).end())}!e.isError&&s||(t.isAjaxReq?a.status(e.status).json(e.value(!e.isError)).end():a.status(e.status).send(e.value(!e.isError)).end())}"function"==typeof s&&s()},f=(e,t,s)=>{let r=new a(e);100===r.status?s():h(r,t)},g=(e=[])=>{let t=[],s=null;for(let r of e){if("string"==typeof r&&r.startsWith("return "))s=new Function(r)();else if("object"==typeof r){for(let e in r)r.hasOwnProperty(e)&&"string"==typeof(s=r[e])&&s.startsWith("return ")&&(s=new Function(r)(),r[e]=s);s=r}else s=r;t.push(s)}return t},m=async(e,s)=>{try{let r=g(e.args),i=null,a=null,n=null,o=null;n=await d(e.name),x(n,"flairtype")&&S(n,t)?(a=new(i=n)).run(s.req,s.res,e=>{throw e},...r):(o=(o=e.func?n[e.func]:n)(...r))(s.req,s.res,e=>{throw e})}catch(t){throw G.OperationFailed(`Middleware ${e.name} failed.`,t)}},y=async(e,t,s,r)=>{let a=S(await d(t),i);if(a){if(e.mw&&e.mw.length>0)for(let t of e.mw)await m(t,r);let t=new a(e);return await t.run(s,r)}throw G.InvalidDefinition(`Invalid route handler. (${t})`)},v=e=>"string"==typeof e.handler?e.handler:e.handler[l.app().getRoutingContext(e.name)]||e.handler.default||"",w=async(e,t,s)=>{let r=v(e);if(!r)throw G.NotDefined(e.handler);return await y(e,r,t,s)},b=(e,t)=>(function(s,r,i){let a=new n(s,r);w(e,t,a).then(e=>{h(e,a,i)}).catch(e=>{f(e,a,i)})}),q=(e,t)=>{let s=t.path;if(c.params){let e=c.params;e.startsWith("/")||(e="/"+e),e.endsWith("/")||(e+="/"),s=(e+=s).replace("//","/")}c.app[e](s,b(t,e))};for(let t of e)if("string"==typeof t.mount&&t.mount===c.name||-1!==t.mount.indexOf(c.name)){let e=[];t.verbs&&0!==t.verbs.length&&e.push(...t.verbs),0===e.length&&e.push("get"),e.forEach(e=>{q(e,t)})}c.app.use((e,t,s)=>{var r;s(G.NotFound(e.originalUrl))}),c.app.use((e,t,s)=>{let r=new a(e);h(r,t,s)})})})})(),await(async()=>{const{Bootware:e}=await E("flair.app");c("sealed"),c("ns","flair.app.bw"),s("SessionStorage",e,function(){c("override"),this.boot=(async e=>{if(e(),!(!0).sessionStorage){const e=function(){let e={};this.key=(t=>!!e[t]),this.getItem=(t=>e[t]||null),this.setItem=((t,s)=>{e[t]=s||null}),this.removeItem=(t=>{delete e[t]}),this.clear=(()=>{e={}})};global.sessionStorage=new e}})})})(),await(async()=>{const{ServerMiddleware:e}=await E("flair.app");c("sealed"),c("ns","flair.server.mw"),s("ResHeaders",e,function(){c("override"),this.onRun=(async(e,t,s,...r)=>{if(e(),r&&r.length>0)for(let e of r)s.set(e.name,e.value)})})})(),l.context.current().currentAssemblyBeingLoaded("","function"==typeof onLoadComplete?onLoadComplete:null),l.registerAdo('{"name":"flair.server","file":"./flair.server{.min}.js","package":"flairjs-fabric","desc":"Foundation for True Object Oriented JavaScript Apps","title":"Flair.js Fabric","version":"0.60.32","lupdate":"Sat, 28 Sep 2019 02:07:52 GMT","builder":{"name":"flairBuild","version":"1","format":"fasm","formatVersion":"1","contains":["init","func","type","vars","reso","asst","rout","sreg"]},"copyright":"(c) 2017-2019 Vikas Burman","license":"MIT","types":["flair.app.ServerMiddleware","flair.api.AttachmentPayload","flair.api.JSONPayload","flair.api.BinaryPayload","flair.api.RestHandlerResult","flair.api.RestHandlerContext","flair.api.RestHandler","flair.app.ServerHost","flair.app.bw.Middlewares","flair.app.bw.NodeEnv","flair.app.bw.ServerRouter","flair.app.bw.SessionStorage","flair.server.mw.ResHeaders"],"resources":[],"assets":["main.js","start.js"],"routes":[]}'),Object.freeze({name:"flair.server",settings:Se,config:qe})});
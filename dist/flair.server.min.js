/**
 * @preserve
 * Flair.js Fabric
 * Foundation for True Object Oriented JavaScript Apps
 * 
 * Assembly: flair.server
 *     File: ./flair.server.js
 *  Version: 0.55.76
 *  Fri, 30 Aug 2019 14:16:58 GMT
 * 
 * (c) 2017-2019 Vikas Burman
 * MIT
 */
!function(e,t){"use strict";"function"==typeof!0&&(!0).amd?(!0)(()=>t):"object"==typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),module.exports=exports=t):e["flair.server"]=t}(this,async function(e,t){"use strict";const{Class:s,Struct:r,Enum:i,Interface:n,Mixin:a,Aspects:o,AppDomain:l,$$:p,attr:c,bring:u,Container:f,include:d,Port:h,on:v,post:m,telemetry:$,Reflector:g,Serializer:y,Tasks:w,as:b,is:x,isDefined:S,isComplies:R,isDerivedFrom:P,isAbstract:A,isSealed:O,isStatic:I,isSingleton:j,isDeprecated:E,isImplements:F,isInstanceOf:C,isMixed:T,getAssembly:H,getAttr:B,getContext:D,getResource:z,getRoute:N,getType:k,ns:M,getTypeOf:J,getTypeName:G,typeOf:V,dispose:_,using:q,Args:L,Exception:U,noop:W,nip:K,nim:Q,nie:X,event:Y}=e,{TaskInfo:Z}=e.Tasks,{env:ee}=e.options,{guid:te,stuff:se,replaceAll:re,splitAndTrim:ie,findIndexByProp:ne,findItemByProp:ae,which:oe,isArrowFunc:le,isASyncFunc:pe,sieve:ce,deepMerge:ue,getLoadedScript:fe,b64EncodeUnicode:de,b64DecodeUnicode:he,lens:ve,globalSetting:me}=e.utils,{$$static:$e,$$abstract:ge,$$virtual:ye,$$override:we,$$sealed:be,$$private:xe,$$privateSet:Se,$$protected:Re,$$protectedSet:Pe,$$readonly:Ae,$$async:Oe,$$overload:Ie,$$enumerate:je,$$dispose:Ee,$$post:Fe,$$on:Ce,$$timer:Te,$$type:He,$$args:Be,$$inject:De,$$resource:ze,$$asset:Ne,$$singleton:ke,$$serialize:Me,$$deprecate:Je,$$session:Ge,$$state:Ve,$$conditional:_e,$$noserialize:qe,$$ns:Le}=p,Ue=ee.isServer||ee.isWorker?null:(!0).document,We=l.context.current().name,Ke=t,Qe=Ke.substr(0,Ke.lastIndexOf("/")+1);l.loadPathOf("flair.server",Qe);let Xe=JSON.parse('{"express":{"server-http":{"enable":false,"port":80,"timeout":-1},"server-https":{"enable":false,"port":443,"timeout":-1,"privateKey":"","publicCert":""}},"firebase":{"firebaseApps":"","serviceAccount":""},"envVars":{"vars":[],"options":{"overwrite":true}},"routing":{"mounts":{"main":"/"},"main-settings":[],"main-middlewares":[],"main-interceptors":[],"main-resHeaders":[]}}'),Ye=e.Port("settingsReader");if("function"==typeof Ye){let e=Ye("flair.server");e&&(Xe=ue([Xe,e],!1))}Xe=Object.freeze(Xe);let Ze=JSON.parse("{}");Ze=Object.freeze(Ze);let et=()=>{};return l.context.current().currentAssemblyBeingLoaded("./flair.server{.min}.js"),await(async()=>{const e=await d("flair.app.Handler");p("ns","flair.api"),s("RestHandler",e,function(){p("private"),this.run=(async(e,t,s)=>{let r=null;if(e!==W)try{r=await e(t,s)}catch(e){s.status(e.status||500).json({status:e.status,message:e.message})}else s.status(501).json({status:"501",message:"Not Implemented"});return r}),this.get=(async(e,t)=>await this.run(this.onGet,e,t)),this.post=(async(e,t)=>await this.run(this.onPost,e,t)),this.put=(async(e,t)=>await this.run(this.onPut,e,t)),this.patch=(async(e,t)=>await this.run(this.onPatch,e,t)),this.delete=(async(e,t)=>await this.run(this.onDelete,e,t)),p("protected"),p("virtual"),p("async"),this.onGet=W,p("protected"),p("virtual"),p("async"),this.onPost=W,p("protected"),p("virtual"),p("async"),this.onPut=W,p("protected"),p("virtual"),p("async"),this.onPatch=W,p("protected"),p("virtual"),p("async"),this.onDelete=W})})(),await(async()=>{const{RestHandler:e}=M("flair.api");p("ns","flair.api"),s("RESTEndPoint",e,function(){})})(),await(async()=>{p("ns","flair.api"),s("RestInterceptor",function(){p("virtual"),p("async"),this.run=W})})(),await(async()=>{p("ns","flair.app"),a("FirebaseApp",function(){const e=require("firebase-admin");p("private"),this.apps={},p("private"),this.fbConfig=null;let t=null;this.projectId={get:()=>(t||(t=process.env.FIREBASE_PROJECT_ID||"")||(e.initializeApp(),t=process.env.GCLOUD_PROJECT||JSON.parse(process.env.FIREBASE_CONFIG).projectId||process.env.GCP_PROJECT),t)},this.firebase=(t=>{if(!this.apps[t]){this.fbConfig||(this.fbConfig=require(l.resolvePath(Xe.firebase.firebaseApps)));let s=this.fbConfig[this.projectId][t],r=require(l.resolvePath(Xe.firebase.serviceAccount));s["credential"]=e.credential.cert(r[this.projectId]),this.apps[t]=e.initializeApp(s,t)}return this.apps[t]})})})(),await(async()=>{const e=await d("flair.app.Host");p("sealed"),p("ns","flair.app"),s("ServerHost",e,function(){let e={},t=null,s=null,r=Xe.express["server-http"],i=Xe.express["server-https"];p("override"),this.construct=(e=>{e("Server")}),this.app={get:()=>this.mounts["main"].app,set:W},this.mounts={get:()=>e,set:W},p("override"),this.boot=(async t=>{t();const s=await d("express | x"),r=(e,t)=>{let s=Xe.routing[`${e}-settings`];if(s&&s.length>0)for(let e of s)t.set(e.name,e.value)};let i=s();r("main",i);let n="",a=null;for(let t of Object.keys(Xe.routing.mounts))"main"===t?(n="/",a=i):(n=Xe.routing.mounts[t],a=s()),e[t]=Object.freeze({name:t,root:n,app:a}),"main"!==t&&(r(t,a),i.use(n,a));e=Object.freeze(e)}),p("override"),this.start=(async e=>{e();const n=await d("fs | x"),a=await d("http | x"),o=await d("https | x"),p=await d("http-shutdown | x");if(r.enable&&((t=p(t=a.createServer(this.app))).on("error",e=>{this.error(e)}),-1!==r.timeout&&(t.timeout=r.timeout)),i.enable){const e=n.readFileSync(l.resolvePath(i.privateKey),"utf8"),t=n.readFileSync(l.resolvePath(i.publicCert),"utf8"),r={key:e,cert:t};(s=p(s=o.createServer(r,this.app))).on("error",e=>{this.error(e)}),-1!==i.timeout&&(s.timeout=i.timeout)}}),p("override"),this.ready=(e=>new Promise((n,a)=>{e();let o=r.port||80,p=process.env.PORT||i.port||443;t&&s?t.listen(o,()=>{s.listen(p,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${o}, https: ${p})`),n()})}):t?t.listen(o,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${o})`),n()}):s?s.listen(p,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (https: ${p})`),n()}):(console.log(`${l.app().info.name}, v${l.app().info.version}`),n())})),p("override"),this.stop=(async e=>{e(),t&&(console.log("http server is shutting down..."),t.shutdown(()=>{t=null,console.log("http server is cleanly shutdown!")})),s&&(console.log("https server is shutting down..."),s.shutdown(()=>{s=null,console.log("https server is cleanly shutdown!")}))}),p("override"),this.dispose=(t=>{t(),e=null})})})(),await(async()=>{const e=await d("flair.app.Bootware");p("sealed"),p("ns","flair.boot"),s("Middlewares",e,function(){p("override"),this.construct=(e=>{e("Express Middlewares",!0)}),p("override"),this.boot=(async(e,t)=>{e();let s=Xe.routing[`${t.name}-middlewares`];if(s&&s.length>0){let e=null,r=null;for(let i of s)if(i.name)try{e=require(i.name),r=i.func?e[i.func]:e;let s=[],n=null;i.args=i.args||[];for(let e of i.args){if("string"==typeof e&&e.startsWith("return "))n=new Function(e)();else if("object"==typeof e){for(let t in e)e.hasOwnProperty(t)&&"string"==typeof(n=e[t])&&n.startsWith("return ")&&(n=new Function(e)(),e[t]=n);n=e}else n=e;s.push(n)}t.app.use(r(...s))}catch(e){throw U.OperationFailed(`Middleware ${i.module} load failed.`,e,this.boot)}}})})})(),await(async()=>{const e=await d("flair.app.Bootware");p("sealed"),p("ns","flair.boot"),s("NodeEnv",e,function(){p("override"),this.construct=(e=>{e("Node Server Environment")}),p("override"),this.boot=(async e=>{if(e(),Xe.envVars.vars.length>0){const e=await d("node-env-file | x");if(e)for(let t of Xe.envVars.vars)e(l.resolvePath(t),Xe.envVars.options)}})})})(),await(async()=>{const e=await d("flair.app.Bootware");p("sealed"),p("ns","flair.boot"),s("ResHeaders",e,function(){p("override"),this.construct=(e=>{e("Server Response Headers",!0)}),p("override"),this.boot=(async(e,t)=>{e();let s=Xe.routing[`${t.name}-resHeaders`];s&&s.length>0&&t.app.use((e,t,r)=>{for(let e of s)t.setHeader(e.name,e.value);r()})})})})(),await(async()=>{const e=await d("flair.app.Bootware");p("sealed"),p("ns","flair.boot"),s("ServerRouter",e,function(){const{RestHandler:e,RestInterceptor:t}=M("flair.api");let s=null;p("override"),this.construct=(e=>{e("Server Router",!0)}),p("override"),this.boot=(async(r,i)=>{r(),s||(s=l.context.current().allRoutes(!0)).sort((e,t)=>e.index<t.index?-1:e.index>t.index?1:0);let n=!1;const a=async(e,s,r)=>{for(let i of e){let e=b(await d(i),t);if(!e)throw U.InvalidDefinition(`Invalid interceptor type. (${i})`);if(await(new e).run(s,r),s.$stop)break}},o=e=>"string"==typeof e.handler?e.handler:e.handler[l.app().getRoutingContext(e.name)]||"**undefined**";for(let t of s)("string"==typeof t.mount&&t.mount===i.name||-1!==t.mount.indexOf(i.name))&&t.verbs.forEach(s=>{i.app[s](t.path,(r,l,p)=>{const c=e=>{p(e)},u=e=>{e||p()},f=()=>{let i=o(t);d(i).then(t=>{let a=b(t,e);if(a)try{q(new a,e=>{(n=e[s](r,l))&&"function"==typeof n.then?n.then(e=>{u(e)}).catch(c):u(n)})}catch(e){c(e)}else c(U.InvalidDefinition(`Invalid route handler. ${i}`))}).catch(c)};r.$stop=!1;let h=Xe.routing[`${i.name}-interceptors`]||[];a(h,r,l).then(()=>{r.$stop?l.end():f()}).catch(e=>{r.stop?l.end():c(e)})})});i.app.use((e,t,s)=>{var r=new Error("Not Found");r.status=404,s(r)}),ee.isProd,i.app.use((e,t,s)=>{s.status(e.status||500),t.xhr?s.status(500).send({error:e.toString()}):s.render("error",{message:e.message,error:e}),s.end()})})})})(),l.context.current().currentAssemblyBeingLoaded(""),l.registerAdo('{"name":"flair.server","file":"./flair.server{.min}.js","package":"flairjs-fabric","desc":"Foundation for True Object Oriented JavaScript Apps","title":"Flair.js Fabric","version":"0.55.76","lupdate":"Fri, 30 Aug 2019 14:16:58 GMT","builder":{"name":"flairBuild","version":"1","format":"fasm","formatVersion":"1","contains":["init","func","type","vars","reso","asst","rout","sreg"]},"copyright":"(c) 2017-2019 Vikas Burman","license":"MIT","types":["flair.api.RestHandler","flair.api.RESTEndPoint","flair.api.RestInterceptor","flair.app.FirebaseApp","flair.app.ServerHost","flair.boot.Middlewares","flair.boot.NodeEnv","flair.boot.ResHeaders","flair.boot.ServerRouter"],"resources":[],"assets":[],"routes":[]}'),Object.freeze({name:"flair.server",settings:Xe,config:Ze})});
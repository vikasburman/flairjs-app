/**
 * @preserve
 * Flair.js Fabric
 * Foundation for True Object Oriented JavaScript Apps
 * 
 * Assembly: flair.server.express
 *     File: ./flair.server.express.js
 *  Version: 0.60.22
 *  Wed, 25 Sep 2019 04:57:45 GMT
 * 
 * (c) 2017-2019 Vikas Burman
 * MIT
 */
!function(e,t){"use strict";"function"==typeof!0&&(!0).amd?(!0)(()=>t):"object"==typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),module.exports=exports=t):e["flair.server.express"]=t}(this,async function(e,t){"use strict";const{Class:r,Struct:s,Enum:n,Interface:i,Mixin:a,Aspects:o,AppDomain:l,$$:p,attr:u,InjectedArg:d,bring:c,Container:f,include:h,Port:m,on:g,post:v,telemetry:y,Reflector:w,Serializer:b,Tasks:x,as:S,is:O,isDefined:$,isComplies:R,isDerivedFrom:j,isAbstract:A,isSealed:I,isStatic:P,isSingleton:H,isDeprecated:M,isImplements:T,isInstanceOf:C,isMixed:D,getAssembly:F,getAttr:B,getContext:E,getResource:k,getRoute:W,getType:N,ns:U,getTypeOf:z,getTypeName:L,typeOf:q,dispose:J,using:K,Args:V,Exception:G,noop:_,nip:Q,nim:X,nie:Y,event:Z}=e,{TaskInfo:ee}=e.Tasks,{env:te}=e.options,{guid:re,stuff:se,replaceAll:ne,splitAndTrim:ie,findIndexByProp:ae,findItemByProp:oe,which:le,isArrowFunc:pe,isASyncFunc:ue,sieve:de,deepMerge:ce,getLoadedScript:fe,b64EncodeUnicode:he,b64DecodeUnicode:me,lens:ge,globalSetting:ve}=e.utils,ye=te.isServer||te.isWorker?null:(!0).document,we=l.context.current().name,be=t,xe=be.substr(0,be.lastIndexOf("/")+1);l.loadPathOf("flair.server.express",xe);let Se=JSON.parse('{"express":{"server-http":{"enable":false,"port":80,"timeout":-1},"server-https":{"enable":false,"port":443,"timeout":-1,"privateKey":"","publicCert":""}},"routing":{"mounts":{"main":"/"},"all":{"before":{"settings":[],"middlewares":[],"interceptors":[],"resHeaders":[]},"after":{"settings":[],"middlewares":[],"interceptors":[],"resHeaders":[]}}}}'),Oe=m("settingsReader");if("function"==typeof Oe){let e=Oe("flair.server.express");e&&(Se=ce([Se,e],!1))}Se=Object.freeze(Se);let $e=JSON.parse("{}");return $e=Object.freeze($e),l.context.current().currentAssemblyBeingLoaded("./flair.server.express{.min}.js"),await(async()=>{const{Host:e}=await U("flair.app");p("sealed"),p("ns","flair.app"),r("ServerHost",e,function(){let e={},t=null,r=null,s=Se.express["server-http"],n=Se.express["server-https"];p("override"),this.construct=(e=>{e("Server")}),this.app={get:()=>this.mounts["main"].app,set:_},this.mounts={get:()=>e,set:_},this.routeToUrl=((e,t,r)=>{if(!e)return null;let s=l.context.current().getRoute(e);if(!s)return ne(e,".","_");let n=s.path;n.startsWith("/")||(n="/"+n);let i=!1;if(t){let e=-1,r="?",s=null;for(let i in t)t.hasOwnProperty(i)&&(e=n.indexOf(`:${i}`),s=encodeURIComponent(t[i].toString()),-1!==e?n=ne(n,`:${i}`,s):r+=`${i}=${s}&`);"?"!==r&&(i=!0,r.endsWith("&")&&(r=r.substr(0,r.length-1)),n+=r)}if(r){let e=i?"&":"?",t=null;for(let s in r)r.hasOwnProperty(s)&&(e+=`${s}=${t=encodeURIComponent(r[s].toString())}&`);"?"===e&&"&"===e||(n+=e)}return n}),p("override"),this.boot=(async t=>{t();const r=await h("express | x"),s=(e,t)=>{let r=this.getMountSpecificSettings("settings",Se.routing,e,"name");if(r&&r.length>0)for(let e of r)t.set(e.name,e.value)};let n=r(),i=(Se.routing["main"]?Se.routing["main"]["params"]:"")||"";s("main",n);let a="",o=null,l="";for(let t of Object.keys(Se.routing.mounts))"main"===t?(a="/",o=n,l=i):(a=Se.routing.mounts[t],l=(Se.routing[t]?Se.routing[t]["params"]:"")||"",o=r()),e[t]=Object.freeze({name:t,root:a,params:l,app:o}),"main"!==t&&(s(t,o),n.use(a,o));e=Object.freeze(e)}),p("override"),this.start=(async e=>{if(e(),te.x().isServerless)return;const i=await h("fs | x"),a=await h("http | x"),o=await h("https | x"),p=await h("http-shutdown | x");if(s.enable&&((t=p(t=a.createServer(this.app))).on("error",e=>{this.error(e)}),-1!==s.timeout&&(t.timeout=s.timeout)),n.enable){const e=i.readFileSync(l.resolvePath(n.privateKey),"utf8"),t=i.readFileSync(l.resolvePath(n.publicCert),"utf8"),s={key:e,cert:t};(r=p(r=o.createServer(s,this.app))).on("error",e=>{this.error(e)}),-1!==n.timeout&&(r.timeout=n.timeout)}}),p("override"),this.ready=(e=>new Promise((i,a)=>{if(e(),te.x().isServerless)return void i();let o=s.port||80,p=process.env.PORT||n.port||443;t&&r?t.listen(o,()=>{r.listen(p,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${o}, https: ${p})`),i()})}):t?t.listen(o,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${o})`),i()}):r?r.listen(p,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (https: ${p})`),i()}):(console.log(`${l.app().info.name}, v${l.app().info.version}`),i())})),p("override"),this.stop=(async e=>{e(),te.x().isServerless||(t&&(console.log("http server is shutting down..."),t.shutdown(()=>{t=null,console.log("http server is cleanly shutdown!")})),r&&(console.log("https server is shutting down..."),r.shutdown(()=>{r=null,console.log("https server is cleanly shutdown!")})))}),p("override"),this.dispose=(t=>{t(),e=null})})})(),await(async()=>{const{Bootware:e}=await U("flair.app");p("sealed"),p("ns","flair.boot"),r("Middlewares",e,function(){p("override"),this.construct=(e=>{e("Express Middlewares",!0)}),p("override"),this.boot=(async(e,t)=>{e();let r=this.getMountSpecificSettings("middlewares",Se.routing,t.name,"name");if(r&&r.length>0){let e=null,s=null;for(let n of r)if(n.name)try{e=require(n.name),s=n.func?e[n.func]:e;let r=[],i=null;n.args=n.args||[];for(let e of n.args){if("string"==typeof e&&e.startsWith("return "))i=new Function(e)();else if("object"==typeof e){for(let t in e)e.hasOwnProperty(t)&&"string"==typeof(i=e[t])&&i.startsWith("return ")&&(i=new Function(e)(),e[t]=i);i=e}else i=e;r.push(i)}t.app.use(s(...r))}catch(e){throw G.OperationFailed(`Middleware ${n.module} load failed.`,e,this.boot)}}})})})(),await(async()=>{const{Bootware:e}=await U("flair.app");p("sealed"),p("ns","flair.boot"),r("ResHeaders",e,function(){p("override"),this.construct=(e=>{e("Server Response Headers",!0)}),p("override"),this.boot=(async(e,t)=>{e();let r=this.getMountSpecificSettings("resHeaders",Se.routing,t.name,"name");r&&r.length>0&&t.app.use((e,t,s)=>{for(let e of r)t.set(e.name,e.value);s()})})})})(),await(async()=>{const{Bootware:e,Payload:t}=await U("flair.app"),{RestInterceptor:s,RestHandler:n,RestHandlerResult:i,RestHandlerContext:a,AttachmentPayload:o,BinaryPayload:u,JSONPayload:d}=await U("flair.api");p("sealed"),p("ns","flair.boot"),r("ServerRouter",e,function(){let e=null;p("override"),this.construct=(e=>{e("Server Router",!0)}),p("override"),this.boot=(async(r,p)=>{r(),e||(e=l.context.current().allRoutes(!0)).sort((e,t)=>e.index<t.index?-1:e.index>t.index?1:0);const c=(e,r)=>{let s=r.req,n=r.res;if(302===e.status){let e=r.getData("redirect-route"),t=r.getData("redirect-status"),s=r.getData("redirect-params"),i=r.getData("redirect-query"),a=l.host().routeToUrl(e,s,i);n.redirect(t,a)}else{let s=!1;if(!e.isError&&O(e.data,t)){for(let t of e.data.resHeaders)n.set(t.name,t.value);O(e.data,o)?(s=!0,n.download(e.data.file,e.data.displayName,e.data.options,e.data.cb).end()):O(e.data,u)?(s=!0,n.end(e.data.buffer,e.data.encoding,e.data.cb)):O(e.data,d)&&(s=!0,n.status(e.status).jsonp(e.value(!0)).end())}!e.isError&&s||(r.isAjaxReq?n.status(e.status).json(e.value(!e.isError)).end():n.status(e.status).send(e.value(!e.isError)).end())}},f=async(e,t)=>{let r=this.getMountSpecificSettings("interceptors",Se.routing,p.name);for(let n of r){let r=S(await h(n),s);if(!r)throw G.InvalidDefinition(`Invalid interceptor type. (${n})`);await(new r).run(e,t)}},m=async(e,t,r,s)=>{let i=S(await h(t),n);if(i){let t=new i(e);return await t.run(r,s)}throw G.InvalidDefinition(`Invalid route handler. (${t})`)},g=e=>"string"==typeof e.handler?e.handler:e.handler[l.app().getRoutingContext(e.name)]||e.handler.default||"",v=(e,t)=>(r,s,n)=>{let o=new a(r,s);const l=e=>{let t=new i(e);100===t.status?n():c(t,o)},p=async()=>{let r=g(e);if(!r)throw G.NotDefined(e);return await m(e,r,t,o)};f(r,s).then(()=>{p().then(e=>{c(e,o)}).catch(l)}).catch(l)},y=(e,t)=>{let r=t.path;if(p.params){let e=p.params;e.startsWith("/")||(e="/"+e),e.endsWith("/")||(e+="/"),r=(e+=r).replace("//","/")}p.app[e](r,v(t,e))};for(let t of e)if("string"==typeof t.mount&&t.mount===p.name||-1!==t.mount.indexOf(p.name)){let e=[];t.verbs&&0!==t.verbs.length&&e.push(...t.verbs),0===e.length&&e.push("get"),e.forEach(e=>{y(e,t)})}p.app.use((e,t,r)=>{var s;r(G.NotFound(e.originalUrl))}),p.app.use((e,t,r)=>{let s=new i(e);c(s,t,r)})})})})(),l.context.current().currentAssemblyBeingLoaded("","function"==typeof onLoadComplete?onLoadComplete:null),l.registerAdo('{"name":"flair.server.express","file":"./flair.server.express{.min}.js","package":"flairjs-fabric","desc":"Foundation for True Object Oriented JavaScript Apps","title":"Flair.js Fabric","version":"0.60.22","lupdate":"Wed, 25 Sep 2019 04:57:45 GMT","builder":{"name":"flairBuild","version":"1","format":"fasm","formatVersion":"1","contains":["init","func","type","vars","reso","asst","rout","sreg"]},"copyright":"(c) 2017-2019 Vikas Burman","license":"MIT","types":["flair.app.ServerHost","flair.boot.Middlewares","flair.boot.ResHeaders","flair.boot.ServerRouter"],"resources":[],"assets":[],"routes":[]}'),Object.freeze({name:"flair.server.express",settings:Se,config:$e})});
/**
 * @preserve
 * Flair.js Fabric
 * Foundation for True Object Oriented JavaScript Apps
 * 
 * Assembly: flair.server.express
 *     File: ./flair.server.express.js
 *  Version: 0.59.81
 *  Sun, 22 Sep 2019 23:44:04 GMT
 * 
 * (c) 2017-2019 Vikas Burman
 * MIT
 */
!function(e,t){"use strict";"function"==typeof!0&&(!0).amd?(!0)(()=>t):"object"==typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),module.exports=exports=t):e["flair.server.express"]=t}(this,async function(e,t){"use strict";const{Class:s,Struct:r,Enum:n,Interface:a,Mixin:i,Aspects:o,AppDomain:l,$$:p,attr:u,bring:d,Container:c,include:f,Port:m,on:g,post:h,telemetry:v,Reflector:y,Serializer:w,Tasks:b,as:x,is:S,isDefined:j,isComplies:O,isDerivedFrom:R,isAbstract:A,isSealed:$,isStatic:H,isSingleton:I,isDeprecated:M,isImplements:P,isInstanceOf:F,isMixed:D,getAssembly:T,getAttr:B,getContext:C,getResource:k,getRoute:N,getType:q,ns:z,getTypeOf:E,getTypeName:L,typeOf:W,dispose:J,using:U,Args:K,Exception:V,noop:G,nip:Q,nim:X,nie:Y,event:Z}=e,{TaskInfo:_}=e.Tasks,{env:ee}=e.options,{guid:te,stuff:se,replaceAll:re,splitAndTrim:ne,findIndexByProp:ae,findItemByProp:ie,which:oe,isArrowFunc:le,isASyncFunc:pe,sieve:ue,deepMerge:de,getLoadedScript:ce,b64EncodeUnicode:fe,b64DecodeUnicode:me,lens:ge,globalSetting:he}=e.utils,ve=ee.isServer||ee.isWorker?null:(!0).document,ye=l.context.current().name,we=t,be=we.substr(0,we.lastIndexOf("/")+1);l.loadPathOf("flair.server.express",be);let xe=JSON.parse('{"express":{"server-http":{"enable":false,"port":80,"timeout":-1},"server-https":{"enable":false,"port":443,"timeout":-1,"privateKey":"","publicCert":""}},"routing":{"mounts":{"main":"/"},"all":{"before":{"settings":[],"middlewares":[],"interceptors":[],"resHeaders":[]},"after":{"settings":[],"middlewares":[],"interceptors":[],"resHeaders":[]}}}}'),Se=m("settingsReader");if("function"==typeof Se){let e=Se("flair.server.express");e&&(xe=de([xe,e],!1))}xe=Object.freeze(xe);let je=JSON.parse("{}");return je=Object.freeze(je),l.context.current().currentAssemblyBeingLoaded("./flair.server.express{.min}.js"),await(async()=>{const{Host:e}=await z("flair.app");p("sealed"),p("ns","flair.app"),s("ServerHost",e,function(){let e={},t=null,s=null,r=xe.express["server-http"],n=xe.express["server-https"];p("override"),this.construct=(e=>{e("Server")}),this.app={get:()=>this.mounts["main"].app,set:G},this.mounts={get:()=>e,set:G},p("override"),this.boot=(async t=>{t();const s=await f("express | x"),r=(e,t)=>{let s=this.getMountSpecificSettings("settings",xe.routing,e,"name");if(s&&s.length>0)for(let e of s)t.set(e.name,e.value)};let n=s(),a=(xe.routing["main"]?xe.routing["main"]["params"]:"")||"";r("main",n);let i="",o=null,l="";for(let t of Object.keys(xe.routing.mounts))"main"===t?(i="/",o=n,l=a):(i=xe.routing.mounts[t],l=(xe.routing[t]?xe.routing[t]["params"]:"")||"",o=s()),e[t]=Object.freeze({name:t,root:i,params:l,app:o}),"main"!==t&&(r(t,o),n.use(i,o));e=Object.freeze(e)}),p("override"),this.start=(async e=>{if(e(),ee.x().isServerless)return;const a=await f("fs | x"),i=await f("http | x"),o=await f("https | x"),p=await f("http-shutdown | x");if(r.enable&&((t=p(t=i.createServer(this.app))).on("error",e=>{this.error(e)}),-1!==r.timeout&&(t.timeout=r.timeout)),n.enable){const e=a.readFileSync(l.resolvePath(n.privateKey),"utf8"),t=a.readFileSync(l.resolvePath(n.publicCert),"utf8"),r={key:e,cert:t};(s=p(s=o.createServer(r,this.app))).on("error",e=>{this.error(e)}),-1!==n.timeout&&(s.timeout=n.timeout)}}),p("override"),this.ready=(e=>new Promise((a,i)=>{if(e(),ee.x().isServerless)return void a();let o=r.port||80,p=process.env.PORT||n.port||443;t&&s?t.listen(o,()=>{s.listen(p,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${o}, https: ${p})`),a()})}):t?t.listen(o,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${o})`),a()}):s?s.listen(p,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (https: ${p})`),a()}):(console.log(`${l.app().info.name}, v${l.app().info.version}`),a())})),p("override"),this.stop=(async e=>{e(),ee.x().isServerless||(t&&(console.log("http server is shutting down..."),t.shutdown(()=>{t=null,console.log("http server is cleanly shutdown!")})),s&&(console.log("https server is shutting down..."),s.shutdown(()=>{s=null,console.log("https server is cleanly shutdown!")})))}),p("override"),this.dispose=(t=>{t(),e=null})})})(),await(async()=>{const{Bootware:e}=await z("flair.app");p("sealed"),p("ns","flair.boot"),s("Middlewares",e,function(){p("override"),this.construct=(e=>{e("Express Middlewares",!0)}),p("override"),this.boot=(async(e,t)=>{e();let s=this.getMountSpecificSettings("middlewares",xe.routing,t.name,"name");if(s&&s.length>0){let e=null,r=null;for(let n of s)if(n.name)try{e=require(n.name),r=n.func?e[n.func]:e;let s=[],a=null;n.args=n.args||[];for(let e of n.args){if("string"==typeof e&&e.startsWith("return "))a=new Function(e)();else if("object"==typeof e){for(let t in e)e.hasOwnProperty(t)&&"string"==typeof(a=e[t])&&a.startsWith("return ")&&(a=new Function(e)(),e[t]=a);a=e}else a=e;s.push(a)}t.app.use(r(...s))}catch(e){throw V.OperationFailed(`Middleware ${n.module} load failed.`,e,this.boot)}}})})})(),await(async()=>{const{Bootware:e}=await z("flair.app");p("sealed"),p("ns","flair.boot"),s("ResHeaders",e,function(){p("override"),this.construct=(e=>{e("Server Response Headers",!0)}),p("override"),this.boot=(async(e,t)=>{e();let s=this.getMountSpecificSettings("resHeaders",xe.routing,t.name,"name");s&&s.length>0&&t.app.use((e,t,r)=>{for(let e of s)t.setHeader(e.name,e.value);r()})})})})(),await(async()=>{const{Bootware:e}=await z("flair.app"),{RestInterceptor:t,RestHandler:r,RestHandlerResult:n,RestHandlerContext:a,AttachmentPayload:i,BinaryPayload:o,JSONPayload:u,Payload:d}=await z("flair.api"),c=require("querystring");p("sealed"),p("ns","flair.boot"),s("ServerRouter",e,function(){let e=null;p("override"),this.construct=(e=>{e("Server Router",!0)}),p("override"),this.boot=(async(s,p)=>{s(),e||(e=l.context.current().allRoutes(!0)).sort((e,t)=>e.index<t.index?-1:e.index>t.index?1:0);const m=(e,t)=>{let s=t.req,r=t.res;const n=()=>{for(let t of e.data.resHeaders)r.set(t.name,t.value)},a=()=>{e.isError?t.isAjaxReq?r.status(e.status).json(e.toObject()).end():r.status(e.status).send(e.toString()).end():(n(),S(e.data,i)?r.download(e.data.file,e.data.displayName,e.data.options,e.data.cb).end():S(e.data,o)?r.end(e.data.buffer,e.data.encoding,e.data.cb):S(e.data,u)?r.status(e.status).jsonp(e.toObject()).end():(S(e.data,d),t.isAjaxReq?r.status(e.status).json(e.toObject()).end():r.status(e.status).send(e.toString()).end()))};if(302===r.status){let e=t.getData("redirect-path"),s=t.getData("redirect-status"),n=t.getData("redirect-additionalInfo");n&&(e+="?"+c.stringify(n)),r.redirect(s,e)}else r.format({auto:a,"text/plain":()=>{r.status(e.status).send(e.toString()).end()},"text/html":()=>{r.status(e.status).send(e.toString()).end()},"application/json":()=>{r.status(e.status).json(e.toObject()).end()},default:a})},g=async(e,s)=>{let r=this.getMountSpecificSettings("interceptors",xe.routing,p.name);for(let n of r){let r=x(await f(n),t);if(!r)throw V.InvalidDefinition(`Invalid interceptor type. (${n})`);await(new r).run(e,s)}},h=async(e,t,s,n)=>{let a=x(await f(t),r);if(a){let t=new a(e);return await t.run(s,n)}throw V.InvalidDefinition(`Invalid route handler. (${t})`)},v=e=>"string"==typeof e.handler?e.handler:e.handler[l.app().getRoutingContext(e.name)]||e.handler.default||"",y=(e,t)=>(s,r,i)=>{let o=new a(s,r);const l=e=>{let t=new n(e);100===t.status?i():m(t,o)},p=async()=>{let s=v(e);if(!s)throw new V.NotDefined(e);return await h(e,s,t,o)};g(s,r).then(()=>{p().then(e=>{m(e,o)}).catch(l)}).catch(l)},w=(e,t)=>{let s=t.path;if(p.params){let e=p.params;e.startsWith("/")||(e="/"+e),e.endsWith("/")||(e+="/"),s=(e+=s).replace("//","/")}p.app[e](s,y(t,e))};for(let t of e)if("string"==typeof t.mount&&t.mount===p.name||-1!==t.mount.indexOf(p.name)){let e=[];t.verbs&&0!==t.verbs.length&&e.push(...t.verbs),0===e.length&&e.push("get"),e.forEach(e=>{w(e,t)})}p.app.use((e,t,s)=>{var r;s(new V.NotFound(e.originalUrl))}),p.app.use((e,t,s)=>{let r=new n(e);m(r,t,s)})})})})(),l.context.current().currentAssemblyBeingLoaded("","function"==typeof onLoadComplete?onLoadComplete:null),l.registerAdo('{"name":"flair.server.express","file":"./flair.server.express{.min}.js","package":"flairjs-fabric","desc":"Foundation for True Object Oriented JavaScript Apps","title":"Flair.js Fabric","version":"0.59.81","lupdate":"Sun, 22 Sep 2019 23:44:04 GMT","builder":{"name":"flairBuild","version":"1","format":"fasm","formatVersion":"1","contains":["init","func","type","vars","reso","asst","rout","sreg"]},"copyright":"(c) 2017-2019 Vikas Burman","license":"MIT","types":["flair.app.ServerHost","flair.boot.Middlewares","flair.boot.ResHeaders","flair.boot.ServerRouter"],"resources":[],"assets":[],"routes":[]}'),Object.freeze({name:"flair.server.express",settings:xe,config:je})});
/**
 * @preserve
 * Flair.js Fabric
 * Foundation for True Object Oriented JavaScript Apps
 * 
 * Assembly: flair.server.express
 *     File: ./flair.server.express.js
 *  Version: 0.59.21
 *  Sun, 08 Sep 2019 20:50:37 GMT
 * 
 * (c) 2017-2019 Vikas Burman
 * MIT
 */
!function(e,t){"use strict";"function"==typeof!0&&(!0).amd?(!0)(()=>t):"object"==typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),module.exports=exports=t):e["flair.server.express"]=t}(this,async function(e,t){"use strict";const{Class:r,Struct:s,Enum:n,Interface:i,Mixin:o,Aspects:a,AppDomain:l,$$:p,attr:c,bring:u,Container:d,include:f,Port:m,on:$,post:g,telemetry:h,Reflector:v,Serializer:y,Tasks:w,as:x,is:b,isDefined:S,isComplies:O,isDerivedFrom:R,isAbstract:j,isSealed:A,isStatic:I,isSingleton:M,isDeprecated:F,isImplements:H,isInstanceOf:P,isMixed:T,getAssembly:k,getAttr:B,getContext:C,getResource:z,getRoute:D,getType:E,ns:L,getTypeOf:W,getTypeName:N,typeOf:J,dispose:K,using:U,Args:V,Exception:q,noop:G,nip:Q,nim:X,nie:Y,event:Z}=e,{TaskInfo:_}=e.Tasks,{env:ee}=e.options,{guid:te,stuff:re,replaceAll:se,splitAndTrim:ne,findIndexByProp:ie,findItemByProp:oe,which:ae,isArrowFunc:le,isASyncFunc:pe,sieve:ce,deepMerge:ue,getLoadedScript:de,b64EncodeUnicode:fe,b64DecodeUnicode:me,lens:$e,globalSetting:ge}=e.utils,{$$static:he,$$abstract:ve,$$virtual:ye,$$override:we,$$sealed:xe,$$private:be,$$privateSet:Se,$$protected:Oe,$$protectedSet:Re,$$readonly:je,$$async:Ae,$$overload:Ie,$$enumerate:Me,$$dispose:Fe,$$post:He,$$on:Pe,$$timer:Te,$$type:ke,$$args:Be,$$inject:Ce,$$resource:ze,$$asset:De,$$singleton:Ee,$$serialize:Le,$$deprecate:We,$$session:Ne,$$state:Je,$$conditional:Ke,$$noserialize:Ue,$$ns:Ve}=p,qe=ee.isServer||ee.isWorker?null:(!0).document,Ge=l.context.current().name,Qe=t,Xe=Qe.substr(0,Qe.lastIndexOf("/")+1);l.loadPathOf("flair.server.express",Xe);let Ye=JSON.parse('{"express":{"server-http":{"enable":false,"port":80,"timeout":-1},"server-https":{"enable":false,"port":443,"timeout":-1,"privateKey":"","publicCert":""}},"routing":{"mounts":{"main":"/"},"all":{"before":{"settings":[],"middlewares":[],"interceptors":[],"resHeaders":[]},"after":{"settings":[],"middlewares":[],"interceptors":[],"resHeaders":[]}}}}'),Ze=e.Port("settingsReader");if("function"==typeof Ze){let e=Ze("flair.server.express");e&&(Ye=ue([Ye,e],!1))}Ye=Object.freeze(Ye);let _e=JSON.parse("{}");return _e=Object.freeze(_e),l.context.current().currentAssemblyBeingLoaded("./flair.server.express{.min}.js"),await(async()=>{const{Host:e}=await L("flair.app");p("sealed"),p("ns","flair.app"),r("ServerHost",e,function(){let e={},t=null,r=null,s=Ye.express["server-http"],n=Ye.express["server-https"];p("override"),this.construct=(e=>{e("Server")}),this.app={get:()=>this.mounts["main"].app,set:G},this.mounts={get:()=>e,set:G},p("override"),this.boot=(async t=>{t();const r=await f("express | x"),s=(e,t)=>{let r=this.getMountSpecificSettings("settings",Ye.routing,e,"name");if(r&&r.length>0)for(let e of r)t.set(e.name,e.value)};let n=r(),i=(Ye.routing["main"]?Ye.routing["main"]["params"]:"")||"";s("main",n);let o="",a=null,l="";for(let t of Object.keys(Ye.routing.mounts))"main"===t?(o="/",a=n,l=i):(o=Ye.routing.mounts[t],l=(Ye.routing[t]?Ye.routing[t]["params"]:"")||"",a=r()),e[t]=Object.freeze({name:t,root:o,params:l,app:a}),"main"!==t&&(s(t,a),n.use(o,a));e=Object.freeze(e)}),p("override"),this.start=(async e=>{if(e(),ee.x().isServerless)return;const i=await f("fs | x"),o=await f("http | x"),a=await f("https | x"),p=await f("http-shutdown | x");if(s.enable&&((t=p(t=o.createServer(this.app))).on("error",e=>{this.error(e)}),-1!==s.timeout&&(t.timeout=s.timeout)),n.enable){const e=i.readFileSync(l.resolvePath(n.privateKey),"utf8"),t=i.readFileSync(l.resolvePath(n.publicCert),"utf8"),s={key:e,cert:t};(r=p(r=a.createServer(s,this.app))).on("error",e=>{this.error(e)}),-1!==n.timeout&&(r.timeout=n.timeout)}}),p("override"),this.ready=(e=>new Promise((i,o)=>{if(e(),ee.x().isServerless)return void i();let a=s.port||80,p=process.env.PORT||n.port||443;t&&r?t.listen(a,()=>{r.listen(p,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${a}, https: ${p})`),i()})}):t?t.listen(a,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${a})`),i()}):r?r.listen(p,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (https: ${p})`),i()}):(console.log(`${l.app().info.name}, v${l.app().info.version}`),i())})),p("override"),this.stop=(async e=>{e(),ee.x().isServerless||(t&&(console.log("http server is shutting down..."),t.shutdown(()=>{t=null,console.log("http server is cleanly shutdown!")})),r&&(console.log("https server is shutting down..."),r.shutdown(()=>{r=null,console.log("https server is cleanly shutdown!")})))}),p("override"),this.dispose=(t=>{t(),e=null})})})(),await(async()=>{const{Bootware:e}=await L("flair.app");p("sealed"),p("ns","flair.boot"),r("Middlewares",e,function(){p("override"),this.construct=(e=>{e("Express Middlewares",!0)}),p("override"),this.boot=(async(e,t)=>{e();let r=this.getMountSpecificSettings("middlewares",Ye.routing,t.name,"name");if(r&&r.length>0){let e=null,s=null;for(let n of r)if(n.name)try{e=require(n.name),s=n.func?e[n.func]:e;let r=[],i=null;n.args=n.args||[];for(let e of n.args){if("string"==typeof e&&e.startsWith("return "))i=new Function(e)();else if("object"==typeof e){for(let t in e)e.hasOwnProperty(t)&&"string"==typeof(i=e[t])&&i.startsWith("return ")&&(i=new Function(e)(),e[t]=i);i=e}else i=e;r.push(i)}t.app.use(s(...r))}catch(e){throw q.OperationFailed(`Middleware ${n.module} load failed.`,e,this.boot)}}})})})(),await(async()=>{const{Bootware:e}=await L("flair.app");p("sealed"),p("ns","flair.boot"),r("ResHeaders",e,function(){p("override"),this.construct=(e=>{e("Server Response Headers",!0)}),p("override"),this.boot=(async(e,t)=>{e();let r=this.getMountSpecificSettings("resHeaders",Ye.routing,t.name,"name");r&&r.length>0&&t.app.use((e,t,s)=>{for(let e of r)t.setHeader(e.name,e.value);s()})})})})(),await(async()=>{const{Bootware:e}=await L("flair.app"),{RestHandler:t,RestInterceptor:s}=await L("flair.api");p("sealed"),p("ns","flair.boot"),r("ServerRouter",e,function(){let e=null;p("override"),this.construct=(e=>{e("Server Router",!0)}),p("override"),this.boot=(async(r,n)=>{r(),e||(e=l.context.current().allRoutes(!0)).sort((e,t)=>e.index<t.index?-1:e.index>t.index?1:0);const i=async(e,t)=>{let r=this.getMountSpecificSettings("interceptors",Ye.routing,n.name);for(let n of r){let r=x(await f(n),s);if(!r)throw q.InvalidDefinition(`Invalid interceptor type. (${n})`);if(await(new r).run(e,t),e.$stop)break}},o=async(e,r,s,n)=>{let i=x(await f(e),t);if(i){let e=new i;return await e[r](s,n)}throw q.InvalidDefinition(`Invalid route handler. (${e})`)},a=e=>"string"==typeof e.handler?e.handler:e.handler[l.app().getRoutingContext(e.name)]||"**undefined**",p=(e,t)=>(r,s,n)=>{const l=e=>{n(e)},p=e=>{e||n()},c=async()=>{let n=a(e);return await o(n,t,r,s)};r.$stop=!1,i(r,s).then(()=>{r.$stop?s.end():c().then(p).catch(l)}).catch(e=>{r.stop?s.end():l(e)})},c=(e,t)=>{let r=t.path;if(n.params){let e=n.params;e.startsWith("/")||(e="/"+e),e.endsWith("/")||(e+="/"),r=(e+=r).replace("//","/")}n.app[e](r,p(t,e))};for(let t of e)("string"==typeof t.mount&&t.mount===n.name||-1!==t.mount.indexOf(n.name))&&t.verbs.forEach(e=>{c(e,t)});n.app.use((e,t,r)=>{var s=new Error("Not Found");s.status=404,r(s)}),ee.isProd,n.app.use((e,t,r)=>{r.status(e.status||500),t.xhr?r.status(500).send({error:e.toString()}):r.render("error",{message:e.message,error:e}),r.end()})})})})(),l.context.current().currentAssemblyBeingLoaded(),l.registerAdo('{"name":"flair.server.express","file":"./flair.server.express{.min}.js","package":"flairjs-fabric","desc":"Foundation for True Object Oriented JavaScript Apps","title":"Flair.js Fabric","version":"0.59.21","lupdate":"Sun, 08 Sep 2019 20:50:37 GMT","builder":{"name":"flairBuild","version":"1","format":"fasm","formatVersion":"1","contains":["init","func","type","vars","reso","asst","rout","sreg"]},"copyright":"(c) 2017-2019 Vikas Burman","license":"MIT","types":["flair.app.ServerHost","flair.boot.Middlewares","flair.boot.ResHeaders","flair.boot.ServerRouter"],"resources":[],"assets":[],"routes":[]}'),"function"==typeof onLoadComplete&&onLoadComplete(),Object.freeze({name:"flair.server.express",settings:Ye,config:_e})});